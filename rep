--====== CONFIG ======--
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

local QUEST_POS = Vector3.new(-1560.9775390625, 22.86717414855957, 825.9608154296875)
local PATROL_POINTS = {
    Vector3.new(-1427.0399169921875, 3.395440101623535, 381.5129699707031),
    Vector3.new(-1401.8236083984375, 2.2898659706115723, -662.8291625976562),
    Vector3.new(-410.2884521484375, 9.776947975158691, -748.5504760742188),
}

local ENEMY_NAME = "Possessed Rider Lv.90"

local DialogueRemote = ReplicatedStorage:WaitForChild("Remote"):WaitForChild("Event"):WaitForChild("Dialogue")
local function fireDialogue(args)
    DialogueRemote:FireServer(unpack(args))
end

--====== FUNGSI DASAR ======--
local function getHRP()
    local char = player.Character or player.CharacterAdded:Wait()
    return char:WaitForChild("HumanoidRootPart")
end

local function tweenTo(pos, time_)
    local hrp = getHRP()
    local info = TweenInfo.new(time_ or 2, Enum.EasingStyle.Sine, Enum.EasingDirection.Out)
    local tween = TweenService:Create(hrp, info, {CFrame = CFrame.new(pos)})
    tween:Play()
    tween.Completed:Wait()
end

local function getEnemy()
    local lives = workspace:FindFirstChild("Lives")
    if not lives then return nil end
    return lives:FindFirstChild(ENEMY_NAME)
end

local function getEnemyRoot(enemy)
    if not enemy then return nil end
    return enemy:FindFirstChild("HumanoidRootPart") or enemy.PrimaryPart
end

--====== AUTO ATTACK ======--
local function fireCombat(argsTable)
    local char = player.Character or player.CharacterAdded:Wait()
    local handler = char:WaitForChild("PlayerHandler"):WaitForChild("HandlerEvent")
    handler:FireServer(unpack(argsTable))
end

local function heavyAttack()
    local args = {
        {
            CombatAction = true,
            AttackType = "Down",
            HeavyAttack = true,
            MouseData = CFrame.new(-257.47, 9.77, -862.22, 1, 0, 0, 0, 1, 0, 0, 0, 1)
        }
    }
    fireCombat(args)
end

local function basicAttack()
    local args = {
        {
            CombatAction = true,
            LightAttack = true,
            MouseData = CFrame.new(-257.47, 9.77, -862.22, 1, 0, 0, 0, 1, 0, 0, 0, 1)
        }
    }
    fireCombat(args)
end

local function skillE()
    local args = {
        {
            Skill = true,
            AttackType = "Down",
            Key = "E",
            MouseData = CFrame.new(-257.47, 9.77, -862.22, 1, 0, 0, 0, 1, 0, 0, 0, 1)
        }
    }
    fireCombat(args)
end

local function skillR()
    local args = {
        {
            Skill = true,
            AttackType = "Down",
            Key = "R",
            MouseData = CFrame.new(-262.78, 5.36, -859.22, 1, 0, 0, 0, 1, 0, 0, 0, 1)
        }
    }
    fireCombat(args)
end

local function skillV()
    local args = {
        {
            Skill = true,
            AttackType = "Down",
            Key = "V",
            MouseData = CFrame.new(-374.33, 10.64, -631.10, 1, 0, 0, 0, 1, 0, 0, 0, 1)
        }
    }
    fireCombat(args)
end

--====== MAGNET KE ENEMY (HEARTBEAT) ======--
local magnetOn = false
local magnetConnection

local function startMagnet()
    if magnetConnection then magnetConnection:Disconnect() end
    magnetOn = true

    magnetConnection = RunService.Heartbeat:Connect(function()
        if not magnetOn then return end

        local lives = workspace:FindFirstChild("Lives")
        local enemy = getEnemy()
        if not lives or not enemy or enemy.Parent ~= lives then
            magnetOn = false
            return
        end

        local enemyRoot = getEnemyRoot(enemy)
        if not enemyRoot then
            magnetOn = false
            return
        end

        local hrp = getHRP()

        -- offset 5 stud di depan enemy (player menghadap enemy)
        local offset = enemyRoot.CFrame.LookVector * 5
        local targetCF = CFrame.new(enemyRoot.Position + offset, enemyRoot.Position)

        -- “magnet” = langsung set / lerp ringan
        hrp.CFrame = hrp.CFrame:Lerp(targetCF, 0.5)
    end)
end

local function stopMagnet()
    magnetOn = false
    if magnetConnection then
        magnetConnection:Disconnect()
        magnetConnection = nil
    end
end

-- Loop serangan: dibiarkan terpisah dari magnet
local function attackEnemyLoop()
    while true do
        local lives = workspace:FindFirstChild("Lives")
        local enemy = getEnemy()
        if not lives or not enemy or enemy.Parent ~= lives then
            break
        end

        -- combo: heavy, E, heavy, basic, R, heavy, V
        heavyAttack()
        task.wait(0.25)

        skillE()
        task.wait(0.4)

        lives = workspace:FindFirstChild("Lives")
        enemy = getEnemy()
        if not lives or not enemy or enemy.Parent ~= lives then break end

        heavyAttack()
        task.wait(0.3)

        basicAttack()
        task.wait(0.35)

        lives = workspace:FindFirstChild("Lives")
        enemy = getEnemy()
        if not lives or not enemy or enemy.Parent ~= lives then break end

        skillR()
        task.wait(0.4)

        heavyAttack()
        task.wait(0.3)

        skillV()
        task.wait(0.45)
    end
end

--====== PROSES QUEST + FARM ======--
local function takeQuest()
    tweenTo(QUEST_POS, 2)

    local npcFolder = workspace:WaitForChild("NPC")
    local arkRep = npcFolder:WaitForChild("ARKReplicator")
    local cd = arkRep:WaitForChild("ClickDetector")
    fireclickdetector(cd)

    fireDialogue({
        {
            Choice = "[ Desire Games ]"
        }
    })

    fireDialogue({
        {
            Exit = true
        }
    })
end

local function turnInQuest()
    tweenTo(QUEST_POS, 2)

    local npcFolder = workspace:WaitForChild("NPC")
    local arkRep = npcFolder:WaitForChild("ARKReplicator")
    local cd = arkRep:WaitForChild("ClickDetector")
    fireclickdetector(cd)

    fireDialogue({
        {
            Choice = "Completed it."
        }
    })

    fireDialogue({
        {
            Exit = true
        }
    })
end

local function patrolUntilEnemy()
    while true do
        local enemy = getEnemy()
        local lives = workspace:FindFirstChild("Lives")
        if enemy and lives and enemy.Parent == lives then
            return enemy
        end

        for _, pos in ipairs(PATROL_POINTS) do
            tweenTo(pos, 2)
            task.wait(0.2)

            enemy = getEnemy()
            lives = workspace:FindFirstChild("Lives")
            if enemy and lives and enemy.Parent == lives then
                return enemy
            end
        end
    end
end

--====== MAIN LOOP ======--
task.spawn(function()
    while true do
        -- 1. Ambil quest
        takeQuest()

        -- 2. Patrol sampai musuh muncul
        local enemy = patrolUntilEnemy()

        -- 3. Nyalakan magnet ke enemy
        startMagnet()

        -- 4. Auto attack sampai enemy mati (magnet tetap jalan)
        attackEnemyLoop()

        -- 5. Matikan magnet ketika enemy sudah mati
        stopMagnet()

        -- 6. Turn in quest
        turnInQuest()

        -- 7. Ulang dari awal
        task.wait(0.5)
    end
end)
